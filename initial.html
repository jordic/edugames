<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dungeon Math Hero</title>
    <style>
        :root {
            --bg-color: #2b2b2b;
            --ui-panel: #3c3f41;
            --health-red: #e74c3c;
            --health-green: #2ecc71;
            --gold: #f1c40f;
            --text-color: #ecf0f1;
        }

        body {
            margin: 0;
            background-color: #1a1a1a;
            color: var(--text-color);
            font-family: 'Verdana', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        /* --- BACKGROUND DECORATION --- */
        .dungeon-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #2c3e50 0%, #000000 100%);
            z-index: -1;
        }

        /* --- MAIN GAME CONTAINER --- */
        #game-stage {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        /* --- HUD (Top) --- */
        .hud-bar {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.2rem;
            text-shadow: 2px 2px 0 #000;
        }

        /* --- MONSTER AREA --- */
        .monster-zone {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .monster-emoji {
            font-size: 8rem;
            filter: drop-shadow(0 0 20px rgba(255,0,0,0.2));
            transition: transform 0.1s;
            cursor: default;
        }
        
        /* Animation: Monster gets hit */
        .hit-anim {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
            filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); /* Flash white/red */
        }

        /* Monster Health Bar */
        .hp-bar-container {
            width: 200px;
            height: 20px;
            background: #000;
            border: 2px solid #555;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
            position: relative;
        }

        .hp-fill {
            height: 100%;
            background: var(--health-red);
            width: 100%;
            transition: width 0.2s;
        }

        /* Floating Damage Text */
        .damage-text {
            position: absolute;
            font-size: 3rem;
            font-weight: 900;
            color: #ffcc00;
            text-shadow: 2px 2px 0 #c0392b, -1px -1px 0 #fff;
            pointer-events: none;
            animation: floatUp 0.8s forwards;
        }

        /* --- BATTLE INTERFACE (Bottom) --- */
        .battle-panel {
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 20px;
            border: 1px solid #555;
            backdrop-filter: blur(5px);
        }

        .math-display {
            text-align: center;
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            color: #fff;
            text-shadow: 0 5px 10px rgba(0,0,0,0.5);
            font-family: 'Courier New', monospace;
        }

        .buttons-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .attack-btn {
            background: linear-gradient(to bottom, #3498db, #2980b9);
            border: none;
            border-radius: 12px;
            padding: 20px;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 6px 0 #1a5276;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .attack-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #1a5276;
        }

        /* --- SCREENS --- */
        .overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .hidden { display: none; }

        .btn-start {
            background: #2ecc71;
            box-shadow: 0 6px 0 #27ae60;
            margin-top: 20px;
            padding: 20px 60px;
            font-size: 1.5rem;
            border-radius: 50px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-start:active { transform: translateY(6px); box-shadow: none;}

        /* --- ANIMATIONS --- */
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0); }
            20%, 80% { transform: translate3d(4px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0); }
            40%, 60% { transform: translate3d(6px, 0, 0); }
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(0.5); }
            50% { transform: translateY(-30px) scale(1.2); }
            100% { opacity: 0; transform: translateY(-60px) scale(1); }
        }

        @keyframes monsterDie {
            0% { transform: scale(1) rotate(0); opacity: 1; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        /* Player takes damage flash */
        .flash-red { animation: flashRed 0.3s; }
        @keyframes flashRed { 0% {background: #721c24;} 100% {background: #1a1a1a;} }

    </style>
</head>
<body>

<div class="dungeon-bg"></div>

<div id="game-stage">
    <div class="hud-bar">
        <span id="floor-display">FLOOR 1</span>
        <span id="timer-display">‚è≥ 60s</span>
    </div>

    <div class="monster-zone">
        <div id="damage-container"></div> <div id="monster" class="monster-emoji">üêâ</div>
        <div class="hp-bar-container">
            <div id="monster-hp" class="hp-fill"></div>
        </div>
    </div>

    <div class="battle-panel">
        <div style="color:#aaa; font-size: 0.9rem; text-align: center; margin-bottom:5px;">COMBAT LOG</div>
        <div id="math-problem" class="math-display">6 x 7</div>
        <div id="buttons-area" class="buttons-grid">
            </div>
    </div>
</div>

<div id="start-screen" class="overlay">
    <h1 style="font-size: 3rem; color: #f1c40f; margin-bottom: 0;">MATH QUEST</h1>
    <p style="color: #ccc;">Defeat the monster to advance!</p>
    <button class="btn-start" onclick="startGame()">ENTER DUNGEON</button>
</div>

<div id="level-up-screen" class="overlay hidden">
    <h1 style="color: #2ecc71">VICTORY!</h1>
    <h2 style="font-size: 4rem;">‚öîÔ∏è</h2>
    <p>The monster is defeated!</p>
    <button class="btn-start" onclick="nextLevel()">DESCEND DEEPER</button>
</div>

<div id="game-over-screen" class="overlay hidden">
    <h1 style="color: #e74c3c">DEFEAT...</h1>
    <p>You ran out of time!</p>
    <button class="btn-start" style="background: #e74c3c; box-shadow: 0 6px 0 #c0392b;" onclick="resetGame()">TRY AGAIN</button>
</div>

<script>
    /* --- ASSETS --- */
    const monsters = ['üëæ', 'üêâ', 'üëπ', 'üë∫', 'üëª', 'ü§ñ', 'üíÄ', 'üßõ', 'üßü', 'ü¶ñ', 'ü¶Ç', 'üï∑Ô∏è'];
    const backgrounds = [
        'radial-gradient(circle at center, #2c3e50 0%, #000000 100%)', // Cave
        'radial-gradient(circle at center, #4a235a 0%, #150b1a 100%)', // Magic Void
        'radial-gradient(circle at center, #145a32 0%, #05130b 100%)', // Swamp
        'radial-gradient(circle at center, #7b241c 0%, #210806 100%)'  // Lava
    ];

    /* --- GAME STATE --- */
    let level = 1;
    let monsterHP = 100; // Percentage
    let maxHP = 100;
    let timeLeft = 60;
    let timerLoop;
    let currentAnswer = 0;
    
    // Config
    const DAMAGE_PER_HIT = 15; // How much player hurts monster
    const PENALTY_TIME = 5;    // Seconds lost for wrong answer
    
    /* --- AUDIO --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        const now = audioCtx.currentTime;
        
        if (type === 'hit') { // Sword slash sound
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now); osc.stop(now + 0.1);
        } else if (type === 'hurt') { // Player hurt (low thud)
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.3);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        }
    }

    /* --- CORE LOGIC --- */
    function init() {
        const saved = localStorage.getItem('dungeonLevel');
        if (saved) level = parseInt(saved);
        updateLevelDisplay();
    }

    function startGame() {
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        
        monsterHP = 100;
        timeLeft = 60;
        updateHPBar();
        
        // Pick random monster and bg
        document.getElementById('monster').innerText = monsters[level % monsters.length];
        document.querySelector('.dungeon-bg').style.background = backgrounds[level % backgrounds.length];
        document.getElementById('monster').style.transform = "scale(1)";
        document.getElementById('monster').style.opacity = "1";

        startTimer();
        generateFight();
    }

    function startTimer() {
        if (timerLoop) clearInterval(timerLoop);
        timerLoop = setInterval(() => {
            timeLeft--;
            document.getElementById('timer-display').innerText = `‚è≥ ${timeLeft}s`;
            if (timeLeft <= 0) gameOver();
        }, 1000);
    }

    function generateFight() {
        // Difficulty Logic
        let multipliers = [2, 5, 10]; // Floor 1-3
        if (level > 3) multipliers = [3, 4, 11];
        if (level > 8) multipliers = [6, 7, 8, 9, 12];
        if (level > 15) multipliers = [2,3,4,5,6,7,8,9,11,12]; // Boss Rush

        const n1 = multipliers[Math.floor(Math.random() * multipliers.length)];
        const n2 = Math.floor(Math.random() * 9) + 2;
        currentAnswer = n1 * n2;

        document.getElementById('math-problem').innerText = `${n1} √ó ${n2}`;
        generateButtons(currentAnswer, n1);
    }

    function generateButtons(correct, base) {
        let opts = new Set([correct]);
        while(opts.size < 4) {
            // Clever distractors: close numbers or same-base multiples
            if (Math.random() > 0.5) opts.add(correct + (Math.random() > 0.5 ? base : -base));
            else opts.add(correct + Math.floor(Math.random() * 10) - 5);
        }
        // Remove invalid numbers (<=0) or duplicates
        let arr = Array.from(opts).filter(n => n > 0 && Number.isInteger(n));
        while(arr.length < 4) arr.push(correct + Math.floor(Math.random()*20)+1); // fallback fill
        
        arr.sort(() => Math.random() - 0.5);

        const container = document.getElementById('buttons-area');
        container.innerHTML = '';
        arr.forEach(num => {
            const btn = document.createElement('button');
            btn.className = 'attack-btn';
            btn.innerText = num;
            btn.onclick = () => attack(num);
            container.appendChild(btn);
        });
    }

    function attack(num) {
        if (num === currentAnswer) {
            // CRITICAL HIT
            playSound('hit');
            monsterHP -= DAMAGE_PER_HIT;
            spawnFloatingText(DAMAGE_PER_HIT, true);
            
            // Visuals
            const mon = document.getElementById('monster');
            mon.classList.remove('hit-anim');
            void mon.offsetWidth; // trigger reflow
            mon.classList.add('hit-anim');

            if (monsterHP <= 0) {
                monsterHP = 0;
                updateHPBar();
                winLevel();
            } else {
                updateHPBar();
                generateFight();
            }
        } else {
            // MISS / PLAYER HIT
            playSound('hurt');
            timeLeft -= PENALTY_TIME;
            document.body.classList.add('flash-red');
            setTimeout(()=>document.body.classList.remove('flash-red'), 300);
            
            document.getElementById('timer-display').style.color = 'red';
            setTimeout(()=>document.getElementById('timer-display').style.color = 'white', 500);
            
            spawnFloatingText("-" + PENALTY_TIME + "s", false);
        }
    }

    function spawnFloatingText(text, isCrit) {
        const el = document.createElement('div');
        el.className = 'damage-text';
        el.innerText = isCrit ? `-${text}` : text;
        el.style.color = isCrit ? '#ffcc00' : '#e74c3c';
        el.style.left = (50 + (Math.random()*20 - 10)) + '%';
        el.style.top = '40%';
        document.getElementById('damage-container').appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function updateHPBar() {
        document.getElementById('monster-hp').style.width = monsterHP + '%';
    }

    function winLevel() {
        clearInterval(timerLoop);
        document.getElementById('monster').style.animation = "monsterDie 0.8s forwards";
        
        setTimeout(() => {
            document.getElementById('level-up-screen').classList.remove('hidden');
        }, 800);
        
        level++;
        localStorage.setItem('dungeonLevel', level);
        updateLevelDisplay();
    }

    function nextLevel() {
        document.getElementById('level-up-screen').classList.add('hidden');
        startGame();
    }

    function gameOver() {
        clearInterval(timerLoop);
        document.getElementById('game-over-screen').classList.remove('hidden');
    }

    function resetGame() {
        if(confirm("Restart from Floor 1?")) {
            level = 1;
            localStorage.setItem('dungeonLevel', 1);
            updateLevelDisplay();
            startGame();
        } else {
             // Just restart current level attempt
             startGame();
        }
    }

    function updateLevelDisplay() {
        document.getElementById('floor-display').innerText = `FLOOR ${level}`;
    }

    init();

</script>
</body>
</html>