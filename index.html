<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <title>Dungeon Math Hero</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Math Hero">
    <meta name="theme-color" content="#000000">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='grad' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%234a0e4e;stop-opacity:1' /><stop offset='100%' style='stop-color:%23111;stop-opacity:1' /></linearGradient></defs><rect width='100' height='100' rx='22' fill='url(%23grad)'/><text y='72' x='50' font-size='65' text-anchor='middle'>üêâ</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêâ</text></svg>">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg-color: #000000;
            --control-bg: #111;
            --accent: #f1c40f;
            --danger: #e74c3c;
            --success: #2ecc71;
            --text-muted: #888;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            height: 100dvh; width: 100vw;
            position: fixed; overflow: hidden;
            touch-action: none;
            display: flex; flex-direction: column; align-items: center;
        }

        #game-wrapper {
            position: relative;
            width: 100%; height: 100%;
            max-width: 600px;
            display: flex; flex-direction: column;
            border-left: 2px solid #111; border-right: 2px solid #111;
        }

        canvas {
            background: radial-gradient(circle at bottom, #2b1d3d 0%, #000 100%);
            width: 100%; flex-grow: 1; height: 0;
            display: block; border-bottom: 4px solid #000;
            image-rendering: pixelated;
        }

        #controls-area {
            flex-shrink: 0;
            background: var(--control-bg);
            display: flex; flex-direction: column;
            justify-content: center;
            border-top: 4px solid #222;
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
        }

        #math-problem {
            text-align: center; font-size: 1.4rem;
            color: var(--accent); margin-bottom: 12px;
            text-shadow: 3px 3px 0 #000; letter-spacing: 2px;
        }

        .buttons-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 10px; width: 100%; height: 120px;
        }

        .attack-btn {
            background: #3498db;
            border: 4px solid #2980b9;
            box-shadow: inset 3px 3px 0 rgba(255,255,255,0.3), 3px 3px 0 #000;
            border-radius: 8px;
            font-size: 1.2rem; font-family: 'Press Start 2P', cursive;
            color: #fff; cursor: pointer;
            touch-action: manipulation; -webkit-tap-highlight-color: transparent;
            display: flex; align-items: center; justify-content: center;
        }
        .attack-btn:active { transform: translate(2px, 2px); box-shadow: inset 1px 1px 0 rgba(255,255,255,0.3), 1px 1px 0 #000; }
        .attack-btn.wrong { background: var(--danger); border-color: #c0392b; animation: shakeBtn 0.3s; }

        .icon-btn {
            position: absolute; top: max(15px, env(safe-area-inset-top));
            font-size: 20px; padding: 10px; cursor: pointer;
            z-index: 50; background: rgba(0,0,0,0.5); border-radius: 50%;
            width: 45px; height: 45px; display: flex; align-items: center; justify-content: center;
            border: 2px solid #555;
        }
        .mute-btn { right: 15px; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 20; text-align: center; padding: 20px;
        }
        .hidden { display: none !important; }
        
        h1 { color: var(--accent); font-size: 1.4rem; line-height: 1.5; margin-bottom: 10px; text-shadow: 4px 4px 0 #c0392b; }
        p { line-height: 1.6; color: #aaa; font-size: 0.7rem; margin-bottom: 20px; max-width: 80%; }
        
        /* --- STATS STYLING --- */
        .stats-box {
            background: #111; border: 2px solid #333;
            padding: 15px; border-radius: 10px;
            margin-bottom: 20px; width: 100%; max-width: 350px;
        }
        .stat-row {
            display: flex; justify-content: space-between;
            margin-bottom: 8px; font-size: 0.7rem; color: #ddd;
        }
        .stat-val { color: var(--accent); }

        /* History Table */
        .history-container {
            width: 100%;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #333;
        }
        .history-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            padding: 8px 0;
            font-size: 0.6rem;
            border-bottom: 1px solid #222;
        }
        .history-header {
            color: #888;
            font-size: 0.5rem;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .res-win { color: var(--success); }
        .res-loss { color: var(--danger); }

        .big-btn {
            padding: 15px 20px; width: 100%; max-width: 250px;
            font-size: 0.9rem; font-family: 'Press Start 2P', cursive;
            background: var(--success); color: #000;
            border: 4px solid #27ae60;
            box-shadow: inset 3px 3px 0 rgba(255,255,255,0.4), 3px 3px 0 #000;
            cursor: pointer; margin-top: 10px;
            -webkit-tap-highlight-color: transparent;
        }
        .secondary-btn { background: #3498db; border-color: #2980b9; margin-top: 15px; }
        .back-btn { background: #555; border-color: #333; color: #fff; margin-top: 15px; }

        .shake { animation: shakeAnim 0.4s; }
        @keyframes shakeAnim { 0%, 100% { transform: translate(0,0); } 20%, 60% { transform: translate(-5px, 5px); } 40%, 80% { transform: translate(5px, -5px); } }
        @keyframes shakeBtn { 0% {transform:translateX(0);} 25%{transform:translateX(-5px);} 75%{transform:translateX(5px);} }

    </style>
</head>
<body>

<div id="game-wrapper">
    <div class="icon-btn mute-btn" onclick="AudioSys.toggleMute()">üîä</div>
    <canvas id="gameCanvas"></canvas>
    
    <div id="controls-area">
        <div id="math-problem">START</div>
        <div id="buttons-grid" class="buttons-grid"></div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>DUNGEON<br>MATH HERO</h1>
        
        <div class="stats-box">
            <div class="stat-row">
                <span>LEVEL</span>
                <span class="stat-val" id="home-level">1</span>
            </div>
            <div class="stat-row">
                <span>GAMES</span>
                <span class="stat-val" id="home-games">0</span>
            </div>
        </div>

        <button class="big-btn" onclick="game.startLevel()">PLAY LEVEL <span id="btn-level-num">1</span></button>
        <button class="big-btn secondary-btn" onclick="game.showStats()">VIEW STATS</button>
    </div>

    <div id="stats-screen" class="overlay hidden">
        <h1 style="font-size: 1.2rem; margin-bottom: 20px;">LAST 10 GAMES</h1>
        
        <div class="stats-box" style="text-align: left; max-width: 400px;">
            <div class="stat-row">
                <span>GLOBAL ACCURACY</span>
                <span class="stat-val" id="stat-accuracy">100%</span>
            </div>
            
            <div class="history-container">
                <div class="history-row history-header">
                    <span>LVL</span>
                    <span>RES</span>
                    <span>ACC</span>
                    <span>TIME</span>
                </div>
                <div id="history-list">
                    </div>
            </div>
        </div>

        <button class="big-btn back-btn" onclick="game.showHome()">BACK</button>
        <div style="margin-top:20px; font-size: 0.6rem; color:#555; text-decoration: underline; cursor: pointer;" onclick="Storage.reset()">Reset All Data</div>
    </div>

    <div id="win-screen" class="overlay hidden">
        <h1 style="color:#2ecc71">VICTORY!</h1>
        <div style="font-size: 4rem; margin: 10px;">üèÜ</div>
        <p>Level Complete!</p>
        <button class="big-btn" onclick="game.nextLevel()">NEXT LEVEL</button>
        <button class="big-btn secondary-btn" onclick="game.showHome()">MENU</button>
    </div>

    <div id="lose-screen" class="overlay hidden">
        <h1 style="color:#e74c3c">DEFEATED</h1>
        <div style="font-size: 4rem; margin: 10px;">üíÄ</div>
        <p id="lose-reason">Try Again</p>
        <button class="big-btn" style="background:#e74c3c; border-color:#c0392b;" onclick="game.restartLevel()">RETRY</button>
        <button class="big-btn secondary-btn" onclick="game.showHome()">MENU</button>
    </div>
</div>

<script>
    // --- STORAGE MANAGER ---
    const Storage = {
        key: 'mathHeroData_v2', // Updated key version
        data: {
            level: 1,
            gamesPlayed: 0,
            hits: 0,
            misses: 0,
            history: [] // Array of { level, result, acc, time }
        },
        load: function() {
            const saved = localStorage.getItem(this.key);
            if (saved) {
                const parsed = JSON.parse(saved);
                // Merge in case we added new fields to existing data
                this.data = { ...this.data, ...parsed };
            }
            this.updateUI();
        },
        save: function() {
            localStorage.setItem(this.key, JSON.stringify(this.data));
            this.updateUI();
        },
        reset: function() {
            if(confirm("Reset all stats and history?")) {
                localStorage.removeItem(this.key);
                location.reload();
            }
        },
        addSession: function(isWin, level, sessionHits, sessionMisses, timeSecs) {
            this.data.gamesPlayed++;
            
            // Calculate Session Accuracy
            const total = sessionHits + sessionMisses;
            const acc = total === 0 ? 0 : Math.round((sessionHits / total) * 100);

            // Create Session Record
            const session = {
                lvl: level,
                win: isWin,
                acc: acc,
                time: timeSecs
            };

            // Add to history (Max 10)
            this.data.history.unshift(session);
            if(this.data.history.length > 10) {
                this.data.history.pop();
            }
            
            this.save();
        },
        recordGlobalStats: function(isHit) {
            if(isHit) this.data.hits++;
            else this.data.misses++;
            this.save();
        },
        levelUp: function() {
            this.data.level++;
            this.save();
        },
        updateUI: function() {
            // Home Screen
            const homeLevel = document.getElementById('home-level');
            if(homeLevel) {
                homeLevel.innerText = this.data.level;
                document.getElementById('btn-level-num').innerText = this.data.level;
                document.getElementById('home-games').innerText = this.data.gamesPlayed;
            }

            // Stats Screen - Global Accuracy
            const total = this.data.hits + this.data.misses;
            let acc = 100;
            if (total > 0) acc = Math.round((this.data.hits / total) * 100);
            document.getElementById('stat-accuracy').innerText = acc + "%";

            // Stats Screen - History List
            const listEl = document.getElementById('history-list');
            if(listEl) {
                listEl.innerHTML = '';
                if(this.data.history.length === 0) {
                    listEl.innerHTML = '<div style="padding:10px; font-size:0.6rem; color:#666; text-align:center;">No games played yet.</div>';
                } else {
                    this.data.history.forEach(s => {
                        const row = document.createElement('div');
                        row.className = 'history-row';
                        row.innerHTML = `
                            <span>${s.lvl}</span>
                            <span class="${s.win ? 'res-win' : 'res-loss'}">${s.win ? 'WIN' : 'LOSS'}</span>
                            <span>${s.acc}%</span>
                            <span>${s.time}s</span>
                        `;
                        listEl.appendChild(row);
                    });
                }
            }
        }
    };

    // --- AUDIO ENGINE ---
    const AudioSys = {
        ctx: null, isMuted: false, bgmInterval: null, bgmNoteIndex: 0,
        init: function() {
            if (!this.ctx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
            }
            if (this.ctx.state === 'suspended') this.ctx.resume();
        },
        toggleMute: function() {
            this.isMuted = !this.isMuted;
            document.querySelector('.mute-btn').innerText = this.isMuted ? 'üîá' : 'üîä';
            if(this.isMuted) this.stopMusic();
            else if (GameState.isRunning) this.startMusic();
        },
        playTone: function(freq, type, duration, vol=0.1) {
            if (this.isMuted || !this.ctx) return;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.type = type; osc.frequency.value = freq;
            osc.connect(gain); gain.connect(this.ctx.destination);
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        playShoot: function() { this.playTone(600, 'square', 0.15, 0.1); },
        playExplosion: function() { this.playTone(100, 'sawtooth', 0.2, 0.2); this.playTone(60, 'square', 0.2, 0.2); },
        playError: function() { this.playTone(150, 'sawtooth', 0.3, 0.2); },
        playWin: function() { this.stopMusic(); setTimeout(()=>this.playTone(523, 'square', 0.1),0); setTimeout(()=>this.playTone(659, 'square', 0.1),150); setTimeout(()=>this.playTone(783, 'square', 0.1),300); setTimeout(()=>this.playTone(1046, 'square', 0.6),450); },
        playLose: function() { this.stopMusic(); setTimeout(()=>this.playTone(300, 'triangle', 0.3),0); setTimeout(()=>this.playTone(280, 'triangle', 0.3),300); setTimeout(()=>this.playTone(200, 'triangle', 0.8),600); },
        startMusic: function() {
            if (this.isMuted || !this.ctx || this.bgmInterval) return;
            const bass=[130,130,196,130,220,220,164,196]; const lead=[523,0,659,0,783,659,523,0];
            this.bgmNoteIndex = 0;
            this.bgmInterval = setInterval(() => {
                if(!GameState.isRunning) return;
                this.playTone(bass[this.bgmNoteIndex%8], 'triangle', 0.2, 0.15);
                if(lead[this.bgmNoteIndex%8]>0) this.playTone(lead[this.bgmNoteIndex%8], 'square', 0.1, 0.05);
                this.bgmNoteIndex++;
            }, 250);
        },
        stopMusic: function() { if (this.bgmInterval) { clearInterval(this.bgmInterval); this.bgmInterval = null; } }
    };

    // --- GAME ENGINE ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let frames = 0;

    function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width); canvas.height = Math.floor(rect.height);
    }
    window.addEventListener('resize', resizeCanvas);
    window.addEventListener('orientationchange', () => setTimeout(resizeCanvas, 100));
    resizeCanvas();

    const GameState = {
        isRunning: false,
        level: 1,
        heroHP: 100,
        maxHeroHP: 100,
        currentAnswer: 0,
        // Session Stats
        startTime: 0,
        sessionHits: 0,
        sessionMisses: 0
    };

    let monster = null;
    let projectiles = [];
    let particles = [];

    // --- GAME OBJECTS ---
    const hero = {
        emoji: 'üõ°Ô∏è', x: 0, y: 0, size: 50,
        draw() {
            this.x = canvas.width / 2; this.y = canvas.height - 40;
            ctx.font = this.size + "px 'Press Start 2P'"; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, this.x, this.y);
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(this.x - 50, this.y + 25, 100, 4);
        }
    };

    class Monster {
        constructor(level) {
            const types = ['üêô', 'üëπ', 'üëΩ', 'ü§ñ', 'üê≤', 'üíÄ'];
            this.emoji = types[(level - 1) % types.length];
            this.x = canvas.width / 2; this.y = 80; this.size = 70;
            this.hp = 100; this.maxHP = 100;
            this.descentSpeed = 0.1 + (level * 0.04); 
        }
        update() { this.y += this.descentSpeed; this.visualX = this.x + Math.sin(frames * 0.05) * 10; }
        pushBack() { this.y -= 40; if (this.y < 70) this.y = 70; }
        pullDown() { this.y += 35; }
        draw() {
            ctx.font = this.size + "px 'Press Start 2P'"; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, this.visualX, this.y);
            const barW = 80;
            ctx.fillStyle = '#000'; ctx.fillRect(this.visualX - barW/2, this.y - 50, barW, 6);
            ctx.fillStyle = '#e74c3c'; ctx.fillRect(this.visualX - barW/2, this.y - 50, (this.hp/this.maxHP)*barW, 6);
        }
    }

    class Projectile {
        constructor(x, y, isPlayer) {
            this.x = x; this.y = y; this.isPlayer = isPlayer;
            this.emoji = isPlayer ? '‚ö°' : 'üî•'; this.speed = isPlayer ? -12 : 8; this.dead = false;
        }
        update() { this.y += this.speed; if (this.y < -50 || this.y > canvas.height + 50) this.dead = true; }
        draw() { ctx.font = "24px 'Press Start 2P'"; ctx.fillText(this.emoji, this.x, this.y); }
    }

    class Particle {
        constructor(x, y, color) {
            this.x = x; this.y = y; this.color = color;
            this.vx = (Math.random() - 0.5) * 10; this.vy = (Math.random() - 0.5) * 10;
            this.life = 1.0; this.size = Math.random() * 8 + 4;
        }
        update() { this.x += this.vx; this.y += this.vy; this.vy += 0.5; this.life -= 0.05; }
        draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, this.size, this.size); ctx.globalAlpha = 1.0; }
    }

    // --- MAIN LOOP ---
    function animate() {
        if (!GameState.isRunning) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        frames++;

        if (monster && monster.y > canvas.height * 0.65) {
            if(frames % 20 < 10) { ctx.fillStyle = "rgba(231, 76, 60, 0.2)"; ctx.fillRect(0, 0, canvas.width, canvas.height); }
        }

        hero.draw();
        
        if (monster) {
            monster.update(); monster.draw();
            if (monster.y + monster.size/3 > hero.y - hero.size/2) { game.lose("BASE DESTROYED!"); return; }
        }

        projectiles.forEach(p => {
            p.update(); p.draw();
            if (p.isPlayer && monster && Math.abs(p.x - monster.x) < 50 && Math.abs(p.y - monster.y) < 50) {
                p.dead = true; monster.pushBack(); damageMonster(20);
                AudioSys.playExplosion(); spawnExplosion(p.x, p.y, '#f1c40f');
            }
            if (!p.isPlayer && Math.abs(p.x - hero.x) < 40 && Math.abs(p.y - hero.y) < 40) {
                p.dead = true; damageHero(25);
                AudioSys.playError(); spawnExplosion(p.x, p.y, '#e74c3c');
                document.body.classList.add('shake'); setTimeout(() => document.body.classList.remove('shake'), 400);
            }
        });

        particles.forEach(p => { p.update(); p.draw(); });
        projectiles = projectiles.filter(p => !p.dead);
        particles = particles.filter(p => p.life > 0);

        drawHUD();
        requestAnimationFrame(animate);
    }

    function drawHUD() {
        ctx.fillStyle = '#222'; ctx.fillRect(10, 10, 150, 15);
        ctx.fillStyle = GameState.heroHP > 30 ? '#2ecc71' : '#e74c3c';
        ctx.fillRect(10, 10, (GameState.heroHP/100)*150, 15);
        ctx.fillStyle = '#fff'; ctx.font = "12px 'Press Start 2P'"; ctx.textAlign = 'left';
        ctx.fillText(`LVL ${GameState.level}`, 10, 45);
        
        // Timer display (optional, but good for feedback)
        const elapsed = Math.floor((Date.now() - GameState.startTime) / 1000);
        ctx.textAlign = 'right';
        ctx.fillText(`TIME: ${elapsed}s`, canvas.width - 10, 45);
    }

    function damageMonster(amt) {
        if (!monster) return;
        monster.hp -= amt;
        if (monster.hp <= 0) {
            monster.hp = 0; spawnExplosion(monster.x, monster.y, '#f1c40f', 50); monster = null;
            setTimeout(() => game.win(), 500);
        }
    }
    function damageHero(amt) {
        GameState.heroHP -= amt;
        if (GameState.heroHP <= 0) { GameState.heroHP = 0; game.lose("SHIELD DEPLETED"); }
    }
    function spawnExplosion(x, y, color, count=15) { for(let i=0; i<count; i++) particles.push(new Particle(x, y, color)); }

    const game = {
        showStats: function() {
            document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
            document.getElementById('stats-screen').classList.remove('hidden');
        },
        showHome: function() {
            document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
            document.getElementById('start-screen').classList.remove('hidden');
            Storage.updateUI(); 
        },
        startLevel: function() {
            AudioSys.init(); AudioSys.startMusic();
            document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
            
            GameState.isRunning = true;
            GameState.heroHP = 100;
            GameState.level = Storage.data.level;
            
            // Session Reset
            GameState.startTime = Date.now();
            GameState.sessionHits = 0;
            GameState.sessionMisses = 0;
            
            monster = new Monster(GameState.level);
            projectiles = []; particles = [];
            resizeCanvas();
            this.nextQuestion();
            animate();
        },
        nextLevel: function() {
            Storage.levelUp();
            this.startLevel();
        },
        restartLevel: function() {
            this.startLevel();
        },
        endSession: function(isWin) {
            GameState.isRunning = false;
            const timeSpent = Math.floor((Date.now() - GameState.startTime) / 1000);
            Storage.addSession(isWin, GameState.level, GameState.sessionHits, GameState.sessionMisses, timeSpent);
        },
        win: function() {
            this.endSession(true);
            AudioSys.playWin();
            document.getElementById('win-screen').classList.remove('hidden');
        },
        lose: function(reason) {
            this.endSession(false);
            AudioSys.playLose();
            document.getElementById('lose-reason').innerText = reason;
            document.getElementById('lose-screen').classList.remove('hidden');
        },
        nextQuestion: function() {
            if (!monster) return;
            let mults = [2,5,10];
            if(GameState.level > 2) mults = [3,4];
            if(GameState.level > 5) mults = [6,7,8,9];
            if(GameState.level > 10) mults = [2,3,4,5,6,7,8,9,11,12];

            const n1 = mults[Math.floor(Math.random()*mults.length)];
            const n2 = Math.floor(Math.random()*9)+2;
            GameState.currentAnswer = n1 * n2;
            document.getElementById('math-problem').innerText = `${n1} √ó ${n2}`;
            this.generateButtons(GameState.currentAnswer, n1);
        },
        generateButtons: function(correct, base) {
            let opts = new Set([correct]);
            while(opts.size < 4) {
                if(Math.random()>0.5) opts.add(correct + (Math.random()>0.5?base:-base));
                else opts.add(correct + Math.floor(Math.random()*10)-5);
            }
            let arr = Array.from(opts).filter(n => n > 0).slice(0,4);
            while(arr.length < 4) arr.push(correct + arr.length + 1);
            arr.sort(()=>Math.random()-0.5);

            const grid = document.getElementById('buttons-grid');
            grid.innerHTML = '';
            arr.forEach(num => {
                const btn = document.createElement('button');
                btn.className = 'attack-btn';
                btn.innerText = num;
                btn.onclick = function() {
                    if(!GameState.isRunning || !monster) return;
                    if(num === GameState.currentAnswer) {
                        AudioSys.playShoot();
                        GameState.sessionHits++;
                        Storage.recordGlobalStats(true);
                        projectiles.push(new Projectile(hero.x, hero.y - 30, true));
                        game.nextQuestion();
                    } else {
                        AudioSys.playError();
                        GameState.sessionMisses++;
                        Storage.recordGlobalStats(false);
                        monster.pullDown();
                        projectiles.push(new Projectile(monster.x, monster.y + 30, false));
                        btn.classList.add('wrong');
                        setTimeout(() => btn.classList.remove('wrong'), 300);
                    }
                };
                grid.appendChild(btn);
            });
        }
    };

    // Initialize Storage
    Storage.load();
    window.game = game;

</script>
</body>
</html>